name: action to update rules
on:
  schedule:
  - cron: '0 1 * * 1'
  workflow_dispatch:
  push:
    branches:
      - main

env:
  RULES_URL: https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online.ini
  DIRECT_URL: https://raw.githubusercontent.com/zouyq/sub-rules/main/DIRCET.list
  PROXY_URL: https://raw.githubusercontent.com/zouyq/sub-rules/main/PROXY.list
  DIRECT_NAME: ruleset=ðŸ™ˆ è‡ªå®šä»£ç†,
  PROXY_NAME: ruleset=ðŸ™‰ è‡ªå®šç›´è¿ž,
  DIRECT_GROUP: custom_proxy_group=ðŸ™‰ è‡ªå®šç›´è¿ž`select`[]DIRECT`[]ðŸš€ èŠ‚ç‚¹é€‰æ‹©`[]â™»ï¸ è‡ªåŠ¨é€‰æ‹©
  PROXY_GROUP: custom_proxy_group=ðŸ™ˆ è‡ªå®šä»£ç†`select`[]ðŸš€ èŠ‚ç‚¹é€‰æ‹©`[]â™»ï¸ è‡ªåŠ¨é€‰æ‹©`[]ðŸŽ¯ å…¨çƒç›´è¿ž`.*

jobs:
  update_rule:
    name: Modifiy repository files
    runs-on: ubuntu-latest
    steps:
      - name: Setup timezone
        uses: zcong1993/setup-timezone@master
        with:
          timezone: Asia/Shanghai
      - name: Checkout repository
        uses: actions/checkout@v2.3.2
      - name: Modifiy the specific files using scripts
        run: |
          wget -N ${RULES_URL} -O ACL4SSR.ini
          tac ACL4SSR.ini | awk '/ruleset/ && !seen{print "'"$DIRECT_NAME$DIRECT_URL"'"; seen++} 1' | tac > temp && cat temp > ACL4SSR.ini
          tac ACL4SSR.ini | awk '/ruleset/ && !seen{print "'"$PROXY_NAME$PROXY_URL"'"; seen++} 1' | tac > temp && cat temp > ACL4SSR.ini
          tac ACL4SSR.ini | awk '/custom_proxy_group/ && !seen{print "'"$DIRECT_GROUP"'"; seen++} 1' | tac > temp && cat temp > ACL4SSR.ini
          tac ACL4SSR.ini | awk '/custom_proxy_group/ && !seen{print "'"$PROXY_GROUP"'"; seen++} 1' | tac > temp && cat temp > ACL4SSR.ini
          echo ";update at $(date +'%Y-%m-%d %H:%M:%S')" >> ACL4SSR.ini
          rm -rf temp
      - name: Commit and push changes
        run: |
          git config --global user.name ${{ github.actor }}
          git add -A
          git commit -m "update at $(date +'%Y-%m-%d %H:%M:%S')"
          git push
  update_sub_converter:
    name: Modifiy repository files
    runs-on: ubuntu-latest
    steps:
      - name: Setup timezone
        uses: zcong1993/setup-timezone@master
        with:
          timezone: Asia/Shanghai
      - name: Checkout repository
        uses: actions/checkout@v2.3.2
        with:
          repository: zouyq/heroku-subconverter
          token: ${{ secrets.GH_PAT }}
          ref: main
      - name: Modifiy the specific files using scripts
        run: sed -i  "s/#### update at.*/#### update at $(date +'%Y-%m-%dT%H:%M:%S')/" README.md
      - name: Commit and push changes
        run: |
          git config --global user.name ${{ github.actor }}
          git add -A
          git commit -m "update at $(date +'%Y-%m-%d %H:%M:%S')"
          git push